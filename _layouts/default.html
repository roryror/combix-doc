<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Example</title>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css">
    <link rel="apple-touch-icon" href="{{ site.baseurl }}/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="{{ site.baseurl }}/touch-icon.png" sizes="192x192">
    <link rel="icon" type="image/png" href="{{ site.baseurl }}/images/favicon.png">

    {% if jekyll.environment == 'production' and site.google_analytics_key != '' %}
        <script>
            window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
            ga('create', '{{ site.google_analytics_key }}', 'auto');
            ga('send', 'pageview');
        </script>
        <script async src='https://www.google-analytics.com/analytics.js'></script>
    {% endif %}
    <style>
        body {
            display: flex;
            position: fixed;
        }
        header {
            position: fixed;
            width: 300px;
            z-index: 850; 
        }
        header h1 {
            z-index: 1000; 
        }
        header form {
            z-index: 1000; 
        }
        nav {
            width: 300px;
            height:720px;
            overflow-y: auto;
            z-index: 900; 
            -ms-overflow-style: none;  /* 适用于 Internet Explorer 和 Edge */
            scrollbar-width: none;  /* 适用于 Firefox */
        }
        .main {
            position: relative;
            padding: 20px;
            flex: 1;
            height:800px;
            overflow-y: auto;
            z-index: 750;
            -ms-overflow-style: none;  /* 适用于 Internet Explorer 和 Edge */
            scrollbar-width: none;  /* 适用于 Firefox */
            transform: translateX(-180px); 
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, opacity 0.3s ease-in-out; /* 添加过渡效果 */
        }
        nav ul {
            width: 300px;
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 900; 
        }
        nav ul li a{
            z-index: 900; 
        }
        nav > ul > li {
            position: relative;
            border-radius: 8px;
            z-index: 900; 
        }
        nav ul ul {
            display: none;
            position: relative;
            top: 100%;
            width: 300px;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            overflow: hidden;
            opacity: 0; /* 添加透明度 */
            max-height: 0; /* 添加最大高度 */
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out; /* 添加过渡效果 */
            z-index: 900; 
        }
        
        nav ul li.open > ul {
            display: block;
            opacity: 1; 
            max-height: 1000px; 
        }
        nav ul ul li {
            width: 300px;
            z-index: 900; 
        }
        nav ul ul li a {
            display: block;
            padding: 10px;
            width: 300px;
            border-radius: 5px;
            text-decoration: none;
            z-index: 900; 
        }
        nav ul ul li a:hover {
            z-index: 900; 
        }
        nav ul li:hover > ul {
            display: block;
            z-index: 900; 
        }
        .toc {
            margin-top: 108px; 
            width: 200px; 
            height: 720px;
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
            z-index: 700;
            -ms-overflow-style: none;  /* 适用于 Internet Explorer 和 Edge */
            scrollbar-width: none;  /* 适用于 Firefox */
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, opacity 0.3s ease-in-out; /* 添加过渡效果 */
            opacity: 0; /* 隐藏时字体透明 */
        }
        .toc:hover {
            width: 200px; /* 悬停时宽度 */
            opacity: 1; /* 悬停时字体可见 */
            z-index: 1; 
        }
        .toc:hover + .main{
            transform: translateX(0);
        }
        .toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .toc ul li {
            margin-bottom: 10px;
        }
        .toc a {
            text-decoration: none;
            color: #666;
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
        }
        .toc .toc-title {
            font-size: 16px;
            font-weight: 600;
        }
        .toc a:hover {
            color: #111;
        }
        .toc a.active {
            color: #111;
        }
    </style>
</head>

<body>
    <header>
        <h1>
            <a href="{{ site.baseurl }}/"><img src="{{ site.baseurl }}/images/emblem.svg" width="40" height="40" alt="{{ site.title }} logo"></a>
            {{ site.title }}
            <button type="button" class="open-nav" id="open-nav"></button>
        </h1>

        <form action="{{ site.baseurl }}/search/" method="get">
            <input type="text" name="q" id="search-input" placeholder="Search" autofocus>
            <input type="submit" value="Search" style="display: none;">
        </form>

        <nav {% if site.show_full_navigation %}class="full-navigation"{% endif %}>
            <ul>
                <li class="nav-item top-level {% if page.url == '/' %}current{% endif %}">
                    {% assign home = site.html_pages | where: 'url', '/' | first %}
                    <a href="{{ site.baseurl }}/">{{ home.title }}</a>
                </li>
            </ul>

            <ul>
                {% assign grouped = site.docs | group_by: 'category' %}
                {% assign ordered_categories = "Overview|How to|Nodes|Models|Templates|Q&A" | split: '|' %}
                {% for category in ordered_categories %}
                        {% for group in grouped %}
                           {% if group.name == category %}
                                <li class="nav-item top-level">
                                    <a href="#">{{ category }}</a> <!-- 使用 category 替代 group.name -->
                                    <ul>
                                        {% assign items = group.items | sort: 'order' %}
                                        {% for item in items %}
                                            <li class="nav-item">
                                                <a href="{{ site.baseurl }}{{ item.url }}">{{ item.title }}</a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </ul>

            <ul>
                <li class="nav-item top-level {% if page.url == '/changelog/' %}current{% endif %}">
                    {% assign changelog = site.html_pages | where: 'url', '/changelog/' | first %}
                    <a href="{{ site.baseurl }}/changelog/">{{ changelog.title }}</a>
                </li>
            </ul>
        </nav>
    </header>

    <aside class="toc">
        <ul id="toc-list">
            <!-- 页内目录项会动态生成 -->
        </ul>
    </aside>
    
    <section class="main">
        <div class="page-header" id="top">
            <h2>{% if page.category %}{{ page.category }}{% else %}{{ site.title }}{% endif %}</h2>
            <h3>{{ page.title }}</h3>
        </div>
        <article class="content">
            {{ content }}
        </article>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('nav .nav-item.top-level');
        
            navItems.forEach(item => {
                let delayTimer;
                let isSubMenuHovered = false; // 标记是否在当前菜单项的二级菜单上
        
                item.addEventListener('mouseover', function () {
                    clearTimeout(delayTimer); // 清除之前的延迟关闭计时器display: block;
                    this.classList.add('open'); // 打开当前菜单
                });
        
                item.addEventListener('mouseout', function (event) {
                    const self = this;
                    const subMenu = this.querySelector('ul');
                    const currentUrl = window.location.pathname;
        
                    // 检查当前菜单项是否包含当前页面链接
                    let containsCurrentPage = false;
                    const subMenuItems = self.querySelectorAll('ul li a');
                    subMenuItems.forEach(subItem => {
                        if (subItem.getAttribute('href') === currentUrl) {
                            clearTimeout(delayTimer);
                            containsCurrentPage = true;
                            this.classList.add('open'); // 打开当前菜单
                        }
                    }});
        
                    // 检查是否在当前菜单项的二级菜单上
                    if (event.relatedTarget && event.relatedTarget.closest('ul') === subMenu) {
                        isSubMenuHovered = true;
                    } else {
                        isSubMenuHovered = false;
                    }
        
                    // 如果当前菜单项不包含当前页面链接，并且指针不在当前菜单项的二级菜单上，则设置过渡效果
                    if (subMenu && !containsCurrentPage && !isSubMenuHovered) {
                        subMenu.style.opacity = '0';
                        subMenu.style.maxHeight = '0';
                         delayTimer = setTimeout(function () {
                            self.classList.remove('open'); // 关闭当前菜单
                            subMenu.style.opacity = ''; // 重置透明度
                            subMenu.style.maxHeight = ''; // 重置最大高度
                        }, 300); // 设置延迟时间为过渡效果的持续时间
                    }
                });
            });
        });



        function generateTOC() {
            const tocList = document.getElementById('toc-list');
            const content = document.querySelector('.content');
            const headers = content.querySelectorAll('h1, h2');

            const pageTitle = '{{ page.title }}';
            const pageTitleId = 'page-title';

            // 添加页面标题（第一个h1）作为第一个项目，使用不同的样式
            if (pageTitle) {
                const titleLi = document.createElement('li');
                const titleA = document.createElement('a');
                titleA.href = '#top';
                titleA.innerText = pageTitle;
                titleA.classList.add('toc-title'); // 添加自定义类名
                titleLi.appendChild(titleA);
                tocList.appendChild(titleLi);
            }
            
            headers.forEach(header => {
                const id = header.innerText.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');
                header.id = id;
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#' + id;
                a.innerText = header.innerText;
                li.appendChild(a);
                tocList.appendChild(li);
            });
            
            // 检查目录中是否只有一个标题，没有其他小标题
            if (headers.length === 0 ) {
                document.querySelector('.toc').style.display = 'none'; // 隐藏目录部分
                document.querySelector('.main').style.transform = 'translateX(60px)'; 
            }
        }
        window.addEventListener('scroll', function () {
            const headers = document.querySelectorAll('.content h1, .content h2');
            let currentActive = null;

            headers.forEach(header => {
                const rect = header.getBoundingClientRect();
                if (rect.top <= 0 && rect.bottom >= 0) {
                    currentActive = header;
                }
            });

            const tocLinks = document.querySelectorAll('.toc a');
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (currentActive && link.getAttribute('href') === '#' + currentActive.id) {
                    link.classList.add('active');
                }
            });
        });

        generateTOC();
    </script>
</body>
</html>
